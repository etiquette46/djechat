<!DOCTYPE html>
<html>
<head>
    <title>Home | DJEsocials</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav>
        <h1>DJEsocials</h1>
        <ul>
            <li><a href="index.html" class="active">Home</a></li>
            <li><a href="friends.html">Friends</a></li>
            <li><a href="conversations.html">Chats</a></li>
            <li><a href="profile.html">Profile</a></li>
        </ul>
    </nav>

    <div id="nickname-modal">
        <div class="card" style="width:300px;">
            <h3>Pick a Nickname</h3>
            <p style="font-size:0.8rem; color:var(--primary)">Cannot be changed later!</p>
            <input type="text" id="nick-input" placeholder="e.g. BassDrop">
            <button id="save-nick" style="width:100%">Claim Identity</button>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <textarea id="post-text" placeholder="Share an article or thought..."></textarea>
            <button id="post-btn">Post Article</button>
        </div>
        <div id="feed"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs, addDoc, orderBy, onSnapshot, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyDTL2zEm3QrFPs8Mctnx889WH0DcM65nFw", authDomain: "djechat-730a0.firebaseapp.com", projectId: "djechat-730a0", storageBucket: "djechat-730a0.firebasestorage.app", messagingSenderId: "843688111797", appId: "1:843688111797:web:adf9bf0b67f8b3f89e98fc" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let userNick = "";

        onAuthStateChanged(auth, async (user) => {
            if (!user) { window.location.href = 'login.html'; return; }
            
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (!userDoc.exists()) {
                document.getElementById('nickname-modal').style.display = 'flex';
            } else {
                userNick = userDoc.data().nickname;
                loadPosts();
            }
        });

        document.getElementById('save-nick').onclick = async () => {
            const nick = document.getElementById('nick-input').value.trim().toLowerCase();
            if (nick.length < 3) return alert("Too short!");

            const q = query(collection(db, "users"), where("nickname", "==", nick));
            const querySnap = await getDocs(q);
            if (!querySnap.empty) return alert("Nickname taken!");

            await setDoc(doc(db, "users", auth.currentUser.uid), {
                uid: auth.currentUser.uid,
                nickname: nick,
                displayName: auth.currentUser.displayName,
                photo: auth.currentUser.photoURL
            });
            location.reload();
        };

        document.getElementById('post-btn').onclick = async () => {
            const text = document.getElementById('post-text').value;
            if (!text) return;
            await addDoc(collection(db, "posts"), {
                text, author: userNick, uid: auth.currentUser.uid, 
                likes: [], comments: [], time: new Date()
            });
            document.getElementById('post-text').value = "";
        };

        function loadPosts() {
            const q = query(collection(db, "posts"), orderBy("time", "desc"));
            onSnapshot(q, (snap) => {
                const feed = document.getElementById('feed');
                feed.innerHTML = "";
                snap.forEach(d => {
                    const p = d.data();
                    const postDiv = document.createElement('div');
                    postDiv.className = 'card';
                    postDiv.innerHTML = `
                        <b style="color:var(--primary)">@${p.author}</b>
                        <p>${p.text}</p>
                        <button class="secondary" onclick="likePost('${d.id}')">‚ù§Ô∏è ${p.likes.length}</button>
                        <button class="secondary" onclick="commentPost('${d.id}')">üí¨ ${p.comments.length}</button>
                        <div style="font-size:0.8rem; margin-top:10px;">
                            ${p.comments.map(c => `<div><b>${c.by}:</b> ${c.text}</div>`).join('')}
                        </div>
                    `;
                    feed.appendChild(postDiv);
                });
            });
        }

        window.likePost = async (id) => {
            await updateDoc(doc(db, "posts", id), { likes: arrayUnion(auth.currentUser.uid) });
        };

        window.commentPost = async (id) => {
            const text = prompt("Add a comment:");
            if (text) await updateDoc(doc(db, "posts", id), { 
                comments: arrayUnion({ by: userNick, text: text }) 
            });
        };
    </script>
</body>
</html>
